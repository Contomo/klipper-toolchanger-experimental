[gcode_macro M104]
rename_existing: M104.1
description: [T<index>] [S<temperature>]
  Set tool temperature.
  T= Tool number, optional. If this parameter is not provided, the current tool is used.
  S= Target temperature
gcode:
  {% if params.T is defined %}
    {% set newparams = ' T=' ~ params.T %}
    {% if params.S is defined %}
      {% set newparams = newparams ~ " TARGET=" ~ params.S %}
    {% endif %}
    SET_TOOL_TEMPERATURE{newparameters}
  {% else %}
    M104.1 {rawparams}
  {% endif %}

[gcode_macro M109]
rename_existing: M109.1
description: [T<index>] [S<temperature>]
  Set tool temperature and wait.
  T= Tool number, optional. If this parameter is not provided, the current tool is used.
  S= Target temperature
gcode:
  {% if params.T is defined %}
    {% set newparams = ' WAIT=1 T=' ~ params.T %}
    {% if params.S is defined %}
      {% set newparams = newparams ~ " TARGET=" ~ params.S %}
    {% endif %}
    SET_TOOL_TEMPERATURE{newparameters}
  {% else %}
    M109.1 {rawparams}
  {% endif %}


[gcode_macro SAVE_TOOLTEMP_STATE]
description: Save tool heater targets for later RESTORE_TOOLTEMP_STATE
variable_slots: {}
gcode:
    {% set name = params.NAME|default('default') %}
    {% set targets = {} %}
    {% for _name in printer.toolchanger.tool_names %}
        {% set tool = printer[_name] %}
        {% if tool.extruder %}
            {% set _ = targets.update( {tool.tool_number: printer[tool.extruder].target} ) %}
        {% endif %}
    {% endfor %}
    {% for tn, _ in targets.items() if params.DISABLE|default(0)|int %}
        M104 T{tn} S0
    {% endfor %}
    {% set _ = slots.update( {name: targets} ) %}
    SET_GCODE_VARIABLE MACRO=SAVE_TOOLTEMP_STATE VARIABLE=slots VALUE="{slots}"

[gcode_macro RESTORE_TOOLTEMP_STATE]
description: Restore tool heater targets saved by SAVE_TOOLTEMP_STATE
gcode:
    {% set name = params.NAME|default('default') %}
    {% set slots = printer['gcode_macro SAVE_TOOLTEMP_STATE'].slots %}
    {% set targets = slots.get(name, {}) %}
    {% for tn, target in targets.items() if targets %}
        M104 T{tn} S{target}
    {% else %}
        RESPOND TYPE=error MSG="RESTORE_TOOLTEMP_STATE: missing state '{name}'"
    {% endfor %}
    {% for tn, target in targets.items() if params.WAIT|default(1)|int %}
        M109 T{tn} S{target}
    {% endfor %}
    {% set _ = slots.pop(name, None) %}
    SET_GCODE_VARIABLE MACRO=SAVE_TOOLTEMP_STATE VARIABLE=slots VALUE="{slots}"
